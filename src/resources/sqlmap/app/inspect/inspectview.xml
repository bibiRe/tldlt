<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<!-- 演示与教程手工映射SQL语句 -->
<sqlMap namespace="App.InspectView">
	<typeAlias alias="dto" type="org.g4studio.core.metatype.impl.BaseDto" />
	<sql id="sqlQueryUserForManage">
		SELECT a.USERID, a.USERNAME, a.SEX, a.DEPTID, b.DEPTNAME
	</sql>
	<sql id="sqlQueryUserForManageCount">
		SELECT count(*) as count
	</sql>
	<sql id="sqlQueryUserForManageCondition1">
		FROM eauser a, eadept b, 
	</sql>
	<sql id="sqlQueryUserForManageCondition2">
		(SELECT distinct a.USERID as USERID FROM eauser a, gpsinfo c, releategpsinfo d where a.deptid and c.GPSInfo_Id = d.GPSInfo_Id and d.Type = 1 and d.ReleateRecordId = a.USERID 
		<dynamic>
			<isNotEmpty prepend="AND" property="deptid">
				a.DEPTID like '$deptid$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="userName">
				a.USERNAME like	'%$userName$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="datetime">
				c.Time > '$datetime$'
			</isNotEmpty>
		</dynamic>
		 order by c.Time desc) c WHERE a.userid = c.userid and a.deptid=b.deptid
	</sql>
	<sql id="sqlQueryUserForManageCondition">
		<include refid="sqlQueryUserForManageCondition1"/>
		<include refid="sqlQueryUserForManageCondition2"/>
	</sql>
	<select id="queryUserForManage" parameterClass="map"
		resultClass="dto">
		<include refid="sqlQueryUserForManage" />
		<include refid="sqlQueryUserForManageCondition" />
	</select>

	<select id="queryUserForManageForPageCount"
		parameterClass="map" resultClass="java.lang.Integer">
		<include refid="sqlQueryUserForManageCount" />
		<include refid="sqlQueryUserForManageCondition" />
	</select>
		
	<sql id="sqlQueryInfoForManage">
		SELECT name, type, time, info
	</sql>
	<sql id="sqlQueryInfoForManageC1">
		FROM (
	</sql>
	<sql id="sqlQueryInfoCommonTypeInfoForManage">
		concat(concat(concat(concat(concat('上报GPS,经度:', cast(c.Longtitude as char(32))), ' 纬度:'), cast(c.Latitude as char(32))), ' 速度:'), cast(c.speed as char(32))) as info
	</sql>
	<sql id="sqlQueryInfoCommonTypeForManage">
		c.Time as time, <include refid="sqlQueryInfoCommonTypeInfoForManage"/>
	</sql>
	<sql id="sqlQueryInfoUserGPSForManage">
		(SELECT a.USERNAME as name, 1 as type, 
		<include refid="sqlQueryInfoCommonTypeForManage"/>
		FROM eauser a, gpsinfo c, releategpsinfo d 
		where  c.GPSInfo_Id = d.GPSInfo_Id and d.Type = 1 and d.ReleateRecordId = a.USERID
		<dynamic>
			<isNotEmpty prepend="AND" property="deptid">
				a.DEPTID like '$deptid$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="infoName">
				a.USERNAME like	'%$infoName$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="datetime">
				c.Time > '$datetime$'
			</isNotEmpty>
		</dynamic>
		 <include refid="sqlQueryInfoForManageC3"/>
		 )
	</sql>


	<sql id="sqlQueryInfoDeviceGPSForManage">	
		UNION
		(SELECT a.Name as name, 2 as type, 
		<include refid="sqlQueryInfoCommonTypeForManage"/>
		FROM device a, gpsinfo c, releategpsinfo d, region e 
		where c.GPSInfo_Id = d.GPSInfo_Id and d.Type = 2 and d.ReleateRecordId = a.Device_ID and a.REGION_ID = e.REGION_ID
		<dynamic>
			<isNotEmpty prepend="AND" property="deptid">
				e.DEPTID like '$deptid$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="infoName">
				a.Name like	'%$infoName$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="datetime">
				c.Time > '$datetime$'
			</isNotEmpty>
		</dynamic>
		 <include refid="sqlQueryInfoForManageC3"/>
		 )
	</sql>

	<sql id="sqlQueryInfoForManageC2">
		) c
<!-- 		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="infoName">
				c.info like	'%$infoName$%'
			</isNotEmpty>
		</dynamic> -->
		
	</sql>
	<sql id="sqlQueryInfoForManageC3">
		order by c.time desc
	</sql>	
	<select id="queryInfoForManage" parameterClass="map"
		resultClass="dto">
		<include refid="sqlQueryInfoForManage" />
		<include refid="sqlQueryInfoForManageC1" />
		<include refid="sqlQueryInfoUserGPSForManage" />
		<include refid="sqlQueryInfoDeviceGPSForManage" />
		<include refid="sqlQueryInfoForManageC2" />
		<include refid="sqlQueryInfoForManageC3" />
	</select>

	<select id="queryInfoForManageForPageCount"
		parameterClass="map" resultClass="java.lang.Integer">
		<include refid="sqlQueryUserForManageCount" />
		<include refid="sqlQueryInfoForManageC1" />
		<include refid="sqlQueryInfoUserGPSForManage" />
		<include refid="sqlQueryInfoDeviceGPSForManage" />
		<include refid="sqlQueryInfoForManageC2" />
	</select>
</sqlMap>