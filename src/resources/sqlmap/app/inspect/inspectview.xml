<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<!-- 演示与教程手工映射SQL语句 -->
<sqlMap namespace="App.InspectView">
	<typeAlias alias="dto" type="org.g4studio.core.metatype.impl.BaseDto" />
	<sql id="sqlQueryUserForManage">
		SELECT a.USERID, a.USERNAME, a.SEX, a.DEPTID, b.DEPTNAME, DATE_FORMAT(c.time, '%Y-%m-%d %H:%i:%S') as time
	</sql>
	<sql id="sqlQueryUserForManageCount">
		SELECT count(*) as count
	</sql>
	<sql id="sqlQueryUserForManageCondition1">
		FROM eauser a, eadept b, 
	</sql>
	<sql id="sqlQueryUserForManageCondition2">		
		(SELECT a.USERID as USERID, max(c.Time) as time FROM eauser a, gpsinfo c, releategpsinfo d where c.GPSInfo_Id = d.GPSInfo_Id and d.Type = 1 and d.ReleateRecordId = a.USERID 
		<dynamic>
			<isNotEmpty prepend="AND" property="deptid">
				a.DEPTID like '$deptid$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="userName">
				a.USERNAME like	'%$userName$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="datetime">
				c.Time > '$datetime$'
			</isNotEmpty>
		</dynamic>
		 GROUP BY a.USERID) c WHERE a.userid = c.userid and a.deptid=b.deptid
	</sql>
	<sql id="sqlQueryUserForManageCondition">
		<include refid="sqlQueryUserForManageCondition1"/>
		<include refid="sqlQueryUserForManageCondition2"/>
	</sql>
	<select id="queryUserForManage" parameterClass="map"
		resultClass="dto">
		<include refid="sqlQueryUserForManage" />
		<include refid="sqlQueryUserForManageCondition" />
	</select>

	<select id="queryUserForManageForPageCount"
		parameterClass="map" resultClass="java.lang.Integer">
		<include refid="sqlQueryUserForManageCount" />
		<include refid="sqlQueryUserForManageCondition" />
	</select>
		
	<sql id="sqlQueryInfoForManage">
		SELECT name, type, DATE_FORMAT(time, '%Y-%m-%d %H:%i:%S') as time, info
	</sql>
	<sql id="sqlQueryInfoForManageC1">
		FROM (
	</sql>
	<sql id="sqlQueryInfoCommonTypeInfoForManageHead">
		concat('{gpsinfoid:', cast(c.GPSInfo_Id as char(32)), ', longtitude:', cast(c.Longtitude as char(32)), ', latitude:', cast(c.Latitude as char(32)), ', speed:', cast(c.speed as char(32))
	</sql>
	<sql id="sqlQueryInfoCommonTypeInfoForManageEnd">
		, '}') as info
	</sql>
	<sql id="sqlQueryInfoCommonTypeInfoForUserManage">
		<include refid="sqlQueryInfoCommonTypeInfoForManageHead"/>, ', userid:"', cast(a.USERID as char(32)), '"'<include refid="sqlQueryInfoCommonTypeInfoForManageEnd"/> 
	</sql>
	<sql id="sqlQueryInfoUserGPSForManage">
		(SELECT a.USERNAME as name, 1 as type, c.Time as time, 
		<include refid="sqlQueryInfoCommonTypeInfoForUserManage"/>
		FROM eauser a, gpsinfo c, releategpsinfo d 
		where  c.GPSInfo_Id = d.GPSInfo_Id and d.Type = 1 and d.ReleateRecordId = a.USERID
		<dynamic>
			<isNotEmpty prepend="AND" property="deptid">
				a.DEPTID like '$deptid$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="infoName">
				a.USERNAME like	'%$infoName$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="datetime">
				c.Time > '$datetime$'
			</isNotEmpty>
		</dynamic>
		 <include refid="sqlQueryInfoForManageC3"/>
		 )
	</sql>
	<sql id="sqlQueryInfoCommonTypeInfoForDeviceManage">
		<include refid="sqlQueryInfoCommonTypeInfoForManageHead"/>, ', deviceid:"', cast(a.DEVICE_ID as char(32)), '"'<include refid="sqlQueryInfoCommonTypeInfoForManageEnd"/> 
	</sql>
	<sql id="sqlQueryInfoDeviceGPSForManage">	
		UNION
		(SELECT a.Name as name, 2 as type, c.Time as time, 
		<include refid="sqlQueryInfoCommonTypeInfoForDeviceManage"/>
		FROM device a, gpsinfo c, releategpsinfo d, region e 
		where c.GPSInfo_Id = d.GPSInfo_Id and d.Type = 2 and d.ReleateRecordId = a.Device_ID and a.REGION_ID = e.REGION_ID
		<dynamic>
			<isNotEmpty prepend="AND" property="deptid">
				e.DEPTID like '$deptid$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="infoName">
				a.Name like	'%$infoName$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="datetime">
				c.Time > '$datetime$'
			</isNotEmpty>
		</dynamic>
		 <include refid="sqlQueryInfoForManageC3"/>
		 )
	</sql>
	<sql id="sqlQueryInfoCommonTypeInfoForPlanDeviceManage">
		<include refid="sqlQueryInfoCommonTypeInfoForManageHead"/>, ', inspectplanid:', cast(g.InspectPlan_ID as char(32)), ', inspectplandeviceid:', cast(f.InspectPlanDevice_ID as char(32))<include refid="sqlQueryInfoCommonTypeInfoForManageEnd"/> 
	</sql>
	<sql id="sqlQueryInfoPlanDeviceForManage">	
		UNION 
		(SELECT t.name, t.type, t.time, t.info FROM 
		(SELECT concat(i.deptname, h.username, '执行', g.Name, '检查', a.Name) as name, 3 as type, c.Time as time, 
		<include refid="sqlQueryInfoCommonTypeInfoForPlanDeviceManage"/>
		FROM device a, gpsinfo c, releategpsinfo d, region e, InspectPlanDevice f, InspectPlan g, eauser h, eadept i
		where c.GPSInfo_Id = d.GPSInfo_Id and d.Type = 3 and d.ReleateRecordId = f.InspectPlanDevice_ID and g.InspectPlan_ID = f.InspectPlan_ID AND f.DEVICE_ID = a.DEVICE_ID and a.REGION_ID = e.REGION_ID and g.ExecuteUserId = h.userID and h.DEPTID=i.DEPTID 
		<dynamic>
			<isNotEmpty prepend="AND" property="deptid">
				e.DEPTID like '$deptid$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="datetime">
				c.Time > '$datetime$'
			</isNotEmpty>
		</dynamic>
		 <include refid="sqlQueryInfoForManageC3"/>
		 ) t
		 <dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="infoName">
				t.Name like '%$infoName$%'
			</isNotEmpty>
		</dynamic>
		 )
	</sql>
	<sql id="sqlQueryInfoCommonTypeInfoForInspectRecordManage">
		concat('{inspectrecordid:', cast(c.InspectRecord_Id as char(32)), ', inspectrecordinfoid:',	cast(c.InspectRecordInfo_Id as char(32)), 
		', inspectstate:', cast(c.state as char(32)), ', inspectplanid:', cast(g.InspectPlan_ID as char(32)), ', planname:"', g.Name,
		'", deptname:"', i.deptname, '", username:"', h.username, '", deviceid:"', a.DEVICE_ID, '", devicename:"', a.Name, '",  remark:"', IFNULL(c.remark, ''), '"'
		<include refid="sqlQueryInfoCommonTypeInfoForManageEnd"/> 
	</sql>
	<sql id="sqlQueryInfoInspectRecordForManage">	
		UNION 
		(SELECT t.name, t.type, t.time, t.info FROM 
		(SELECT concat(i.deptname, h.username, '完成', a.Name, '巡检') as name, 4 as type, c.Time as time, 
		<include refid="sqlQueryInfoCommonTypeInfoForInspectRecordManage"/> 
		FROM device a, InspectRecordInfo c, region e, InspectPlanDevice f, InspectPlan g, eauser h, eadept i
		where c.InspectPlanDevice_Id = f.InspectPlanDevice_Id and g.InspectPlan_ID = f.InspectPlan_ID AND f.DEVICE_ID = a.DEVICE_ID and a.REGION_ID = e.REGION_ID and g.ExecuteUserId = h.userID and h.DEPTID=i.DEPTID 
		<dynamic>
			<isNotEmpty prepend="AND" property="deptid">
				e.DEPTID like '$deptid$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="datetime">
				c.Time > '$datetime$'
			</isNotEmpty>
		</dynamic>
		 <include refid="sqlQueryInfoForManageC3"/>
		 ) t
		 <dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="infoName">
				t.Name like '%$infoName$%'
			</isNotEmpty>
		</dynamic>
		 )
	</sql>
	<sql id="sqlQueryInfoCommonTypeInfoForDeviceSuggestManage">
		concat('{devicesuggestinfoid:', cast(c.DeviceSuggestInfo_Id as char(32)), ', deptname:"', b.deptname, '", username:"', a.username, '", deviceid:"', c.DEVICE_ID, '", devicename:"', d.Name, '",  remark:"', IFNULL(c.Content, ''), '"'
		<include refid="sqlQueryInfoCommonTypeInfoForManageEnd"/> 
	</sql>
	<sql id="sqlQueryInfoDeviceSuggestForManage">
		UNION 
		(SELECT t.name, t.type, t.time, t.info FROM
		(SELECT concat(b.deptname, a.USERNAME, '上报设备', d.name, '情况') as name, 5 as type, c.Time as time,
		<include refid="sqlQueryInfoCommonTypeInfoForDeviceSuggestManage"/> 		
		FROM eauser a, eadept b, DeviceSuggestInfo c, device d
		where  c.USERID = a.USERID and c.DEVICE_ID = d.DEVICE_ID and a.DEPTID = b.DEPTID
		<dynamic>
			<isNotEmpty prepend="AND" property="deptid">
				a.DEPTID like '$deptid$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="datetime">
				c.Time > '$datetime$'
			</isNotEmpty>
		</dynamic>
		 <include refid="sqlQueryInfoForManageC3"/>
		 ) t
		 <dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="infoName">
				t.Name like '%$infoName$%'
			</isNotEmpty>
		</dynamic>
		 )
	</sql>
	<sql id="sqlQueryInfoForManageC2">
		) c	
	</sql>
	<sql id="sqlQueryInfoForManageC3">
		order by c.time desc
	</sql>	
	<sql id="sqlQueryInfoForManageCommon">
			<include refid="sqlQueryInfoForManageC1" />
		<include refid="sqlQueryInfoUserGPSForManage" />
		<include refid="sqlQueryInfoDeviceGPSForManage" />
		<include refid="sqlQueryInfoPlanDeviceForManage" />
 		<include refid="sqlQueryInfoInspectRecordForManage" />
 		<include refid="sqlQueryInfoDeviceSuggestForManage" />
		<include refid="sqlQueryInfoForManageC2" />
	</sql>
	<select id="queryInfoForManage" parameterClass="map"
		resultClass="dto">
		<include refid="sqlQueryInfoForManage" />
		<include refid="sqlQueryInfoForManageCommon" />		
		<include refid="sqlQueryInfoForManageC3" />
	</select>

	<select id="queryInfoForManageForPageCount"
		parameterClass="map" resultClass="java.lang.Integer">
		<include refid="sqlQueryUserForManageCount" />
		<include refid="sqlQueryInfoForManageCommon" />			
	</select>
	<sql id="sqlQueryFaultInfoForManage">
		SELECT c.DeviceFaultInfo_Id as devicefaultinfoid, d.Name as devicename, c.Reporter, a.USERNAME, b.deptname, DATE_FORMAT(c.time, '%Y-%m-%d %H:%i:%S') as time, c.state, c.FaultInfo, c.DEVICE_ID as deviceid			
	</sql>
	<sql id="sqlQueryFaultInfoForManageCondition">
		FROM devicefaultinfo c, eauser a, eadept b, device d WHERE c.Reporter = a.USERID AND a.DEPTID = b.DEPTID and c.DEVICE_ID=d.DEVICE_ID
		<dynamic>
			<isNotEmpty prepend="AND" property="deptid">
				b.DEPTID like '$deptid$%'
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="faultInfoName">
				((a.USERNAME like '%$faultInfoName$%')  OR (d.Name like '%$faultInfoName$%') OR (c.FaultInfo like '%$faultInfoName$%'))  
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="datetime">
				c.Time > '$datetime$'
			</isNotEmpty>
		</dynamic> 
	</sql>
	<select id="queryFaultInfoForManage" parameterClass="map"
		resultClass="dto">
		<include refid="sqlQueryFaultInfoForManage" />
		<include refid="sqlQueryFaultInfoForManageCondition" />		
		<include refid="sqlQueryInfoForManageC3" />
	</select>
	<select id="queryFaultInfoForManageForPageCount"
		parameterClass="map" resultClass="java.lang.Integer">
		<include refid="sqlQueryUserForManageCount" />
		<include refid="sqlQueryFaultInfoForManageCondition" />			
	</select>
</sqlMap>