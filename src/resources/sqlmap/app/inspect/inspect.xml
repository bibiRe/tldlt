<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<!-- 演示与教程手工映射SQL语句 -->
<sqlMap namespace="App.Inspect">
	<typeAlias alias="dto" type="org.g4studio.core.metatype.impl.BaseDto" />
	<select id="queryImages" parameterClass="map" resultClass="dto">
		SELECT a.MediaInfo_Id as mediainfoid, a.Type, UNIX_TIMESTAMP(a.Time) as time,
		a.address as mediaurl, a.HashValue, b.ReleateRecordId, b.Type as releatetype
		FROM mediainfo a, releatemediainfo b
		WHERE a.MediaInfo_Id = b.MediaInfo_Id
		<dynamic>
			<isNotEmpty prepend="AND" property="inspectrecordinfoid">b.ReleateRecordId = #inspectrecordinfoid# and b.Type= '1'</isNotEmpty>
			<isNotEmpty prepend="AND" property="inspectrecorditemid">b.ReleateRecordId = #inspectrecorditemid# and b.Type= '2'</isNotEmpty>
		</dynamic>
	</select>
	<select id="queryInspectRecordIdByPlanId" parameterClass="int"
		resultClass="int">
		SELECT a.InspectRecord_Id as inspectrecordid from InspectRecord a where
		a.InspectPlan_Id = #planID#
	</select>
	<select id="queryInspectRecordDeviceFinished" parameterClass="int"
		resultClass="int">
		select count(*) as inspectRecordCount from (
		SELECT IFNULL(a.InspectPlanDevice_Id, 0) as aId, b.InspectPlanDevice_Id as
		bId
		FROM InspectRecordInfo a RIGHT JOIN InspectPlanDevice b on
		a.InspectPlanDevice_Id = b.InspectPlanDevice_Id where b.InspectPlan_Id
		= #planID#) d where d.aId = 0
	</select>
	<select id="queryInspectRecordInfoByPlanDeviceId"
		parameterClass="int" resultClass="dto">
		SELECT a.InspectRecordInfo_Id as inspectrecordinfoid, a.InspectRecord_Id as
		inspectrecordid, a.InspectPlanDevice_Id FROM InspectRecordInfo a
		WHERE a.InspectPlanDevice_Id = #inspectplandeviceid#
	</select>
	<select id="queryInspectRecordInfoById" parameterClass="int"
		resultClass="dto">
		SELECT a.InspectRecordInfo_Id as inspectrecordinfoid, a.InspectRecord_Id as
		inspectrecordid, a.InspectPlanDevice_Id FROM InspectRecordInfo a
		WHERE a.InspectRecordInfo_Id = #inspectrecordinfoid#
	</select>
	<select id="queryInspectRecordItemById" parameterClass="dto"
		resultClass="dto">
		SELECT a.InspectRecordItem_Id as inspectrecorditemid, a.DeviceCheckContent_Id as
		devicecheckcontentid, a.InspectRecordInfo_Id as inspectrecordinfoid FROM inspectrecorditem a
		WHERE a.InspectRecordItem_Id = #inspectrecorditemid#
	</select>

	<insert id="addInspectRecord" parameterClass="dto">
		INSERT INTO InspectRecord (InspectPlan_Id, ExecuteStartTime)
		VALUES (#planID#, '$time$')
		<selectKey resultClass="int" keyProperty="inspectrecordid">SELECT last_insert_id() as inspectrecordid;</selectKey>
	</insert>
	<insert id="addInspectRecordInfo" parameterClass="dto">
		INSERT INTO InspectRecordInfo (InspectRecord_Id, InspectPlanDevice_Id,
		State, Time, Remark)
		VALUES (#inspectrecordid#, #inspectplandeviceid#, #state#, '$time$',
		#checkdesc#)
		<selectKey resultClass="int" keyProperty="inspectrecordinfoid">SELECT last_insert_id() as inspectrecordinfoid;</selectKey>
	</insert>
	<update id="updateInspectRecordFinished" parameterClass="dto">
		UPDATE
		InspectRecord SET ExecuteEndTime = '$time$' WHERE InspectRecord_Id =
		#inspectrecordid#
	</update>

	<insert id="addReleateMediaInfo" parameterClass="dto">
		INSERT INTO ReleateMediaInfo (MediaInfo_Id, Type, ReleateRecordId,Remark)
		VALUES (#mediainfoid#, 1, #inspectrecordinfoid#, #remark#)
		<selectKey resultClass="int" keyProperty="releatemediaid">SELECT last_insert_id() as releatemediaid;</selectKey>
	</insert>
	<insert id="addReleateMediaItemInfo" parameterClass="dto">
		INSERT INTO ReleateMediaInfo (MediaInfo_Id, Type, ReleateRecordId,Remark)
		VALUES (#mediainfoid#, 2, #inspectrecorditemid#, #remark#)
		<selectKey resultClass="int" keyProperty="releatemediaid">SELECT last_insert_id() as releatemediaid;</selectKey>
	</insert>
	<select id="queryInspectRecordByDeviceId" parameterClass="string"
        resultClass="dto">
		SELECT a.InspectRecordInfo_Id as inspectRecordInfoId, a.InspectRecord_Id as inspectRecordID, a.State, UNIX_TIMESTAMP(a.Time) as checkTime, 
        b.InspectPlan_Id as inspectPlanId, b.ExecuteUserId as executorUserId, e.username as executor, IFNULL(b.Remark, '') as checkDesc
        FROM InspectRecordInfo a, InspectPlan b, InspectRecord c, InspectPlanDevice d, eauser e
        WHERE a.InspectRecord_Id = c.InspectRecord_Id AND b.InspectPlan_Id=c.InspectPlan_Id 
        AND a.InspectPlanDevice_Id = d.InspectPlanDevice_Id AND e.userid = b.ExecuteUserId AND d.Device_Id = #deviceID#
	</select>

	<select id="queryInspectRecordByPlanId" parameterClass="int"
		resultClass="dto">
		SELECT a.InspectRecord_Id as inspectrecordid,  a.InspectPlan_Id as inspectplanid,  UNIX_TIMESTAMP(a.ExecuteStartTime) as executestarttime, UNIX_TIMESTAMP(a.ExecuteEndTime) as executeendtime 
		FROM inspectrecord a
		WHERE a.InspectPlan_Id = #planID#
	</select>

	<select id="queryInspectRecordInfoByInspectRecordId" parameterClass="int"
		resultClass="dto">
		SELECT a.InspectRecordInfo_Id as inspectrecordinfoid, a.InspectRecord_Id as inspectrecordid, a.InspectPlanDevice_Id as inspectplandeviceid, a.State, UNIX_TIMESTAMP(a.Time) as time, a.Remark, c.Name as devicename
		FROM inspectrecordinfo a, InspectPlanDevice b, device c 
		WHERE a.InspectPlanDevice_Id  = b.InspectPlanDevice_Id and b.DEVICE_ID = c.DEVICE_ID AND a.InspectRecord_Id = #inspectreocrdid#
	</select>
</sqlMap>